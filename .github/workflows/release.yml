---
# THIS FILE IS GENERATED! DO NOT EDIT! Maintained by Pulumi
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Release
on:
  push:
    tags:
      - "v*"
permissions: {}
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true
jobs:
  changelog:
    name: Generate changelog
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      release_body: ${{ steps.git-cliff.outputs.content }}
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Generate a changelog
        id: git-cliff
        uses: orhun/git-cliff-action@e16f179f0be49ecdfe63753837f20b9531642772 # v4.7.0
        with:
          config: .github/cliff.toml
          args: -vv --current
        env:
          OUTPUT: CHANGELOG.md
          GITHUB_REPO: ${{ github.repository }}

  create-draft-release:
    name: Create release as draft
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    needs: [changelog]
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Create release as draft
        run: |
          if [[ "$GITHUB_REF_NAME" =~ (alpha|beta|rc) ]]; then
            gh release create ${GITHUB_REF_NAME}  -t "Release ${GITHUB_REF_NAME}" -n "${RELEASE_BODY}" --draft --prerelease
          else
            gh release create ${GITHUB_REF_NAME}  -t "Release ${GITHUB_REF_NAME}" -n "${RELEASE_BODY}" --draft
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_BODY: ${{ needs.changelog.outputs.release_body }}

  build-artifact:
    name: Build binary
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
    outputs:
      version: ${{ steps.generate-filename.outputs.VERSION }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-24.04
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm
          - os: darwin
            arch: amd64
            runner: macos-15-intel
          - os: darwin
            arch: arm64
            runner: macos-15
          - os: windows
            arch: amd64
            runner: windows-2025
          - os: windows
            arch: arm64
            runner: windows-11-arm
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: stable
          cache: false

      - name: Get Git commit timestamps
        run: echo "TIMESTAMP=$(git log -1 --pretty=%ct)" >> $GITHUB_ENV

      - name: Generate filenames
        id: generate-filename
        shell: bash
        run: |
          # Get repo name
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)

          # Get version
          VERSION=$(echo "${GITHUB_REF_NAME}" | sed 's/^v//')

          # Set output
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "BINARY_NAME=${REPO_NAME}" >> $GITHUB_OUTPUT
          echo "SBOM_NAME=${REPO_NAME}-${VERSION}-${{ matrix.os }}-${{ matrix.arch }}.sbom" >> $GITHUB_OUTPUT
          echo "TAR_GZ_NAME=${REPO_NAME}-${VERSION}-${{ matrix.os }}-${{ matrix.arch }}.tar.gz" >> $GITHUB_OUTPUT

      - name: Build binary
        run: go build -trimpath -a -o "${BINARY_NAME}" -ldflags '-w -X main.version=${GITHUB_REF_NAME} -X main.buildTime=${TIMESTAMP} -extldflags "-static"'
        shell: bash
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 0
          BINARY_NAME: ${{ steps.generate-filename.outputs.BINARY_NAME }}
          TIMESTAMP: ${{ env.TIMESTAMP }}

      - name: Create tar.gz of binary with license and readme
        run: tar -czf ${TAR_GZ_NAME} ${BINARY_NAME} LICENSE.txt LICENSE_en.txt README.md
        shell: bash
        env:
          TAR_GZ_NAME: ${{ steps.generate-filename.outputs.TAR_GZ_NAME }}
          BINARY_NAME: ${{ steps.generate-filename.outputs.BINARY_NAME }}

      - name: Generate SBOM
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          scan-type: fs
          scan-ref: .
          format: cyclonedx
          output: ${{ steps.generate-filename.outputs.SBOM_NAME }}

      - name: Upload artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: artifacts-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            ${{ steps.generate-filename.outputs.TAR_GZ_NAME }}
            ${{ steps.generate-filename.outputs.SBOM_NAME }}
          if-no-files-found: error
          retention-days: 1

  sign-publish-artifact:
    name: Sign and publish artifact
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      id-token: write # needed for signing the artifact with GitHub OIDC Token
    needs: [create-draft-release, build-artifact]
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Downloads artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: artifacts-*
          merge-multiple: true
          path: ${{ runner.temp }}/artifacts

      - name: Create checksum file
        working-directory: ${{ runner.temp }}/artifacts
        run: |
          shopt -s nullglob
          for archive in *.tar.gz; do
            echo "Generate checksum for ${archive}"
            CHECKSUM=$(sha256sum ${archive})
            echo $CHECKSUM >> checksums.txt
          done

      - name: Sign the artifacts with GitHub OIDC Token
        working-directory: ${{ runner.temp }}/artifacts
        env:
          COSIGN_YES: true
        run: |
          shopt -s nullglob
          for archive in *.tar.gz; do
            archive_without_ext="${archive%.tar.gz}"

            echo "Sign archive for ${archive}"
            cosign sign-blob ${archive} \
              --bundle ${archive_without_ext}.sigstore.json
          done

      - name: Attest SBOM
        working-directory: ${{ runner.temp }}/artifacts
        run: |
          shopt -s nullglob
          for sbom in *.sbom; do
            sbom_without_ext="${sbom%.sbom}"

            echo "Attest sbom file ${sbom}"
            cosign attest-blob -y \
              --type cyclonedx \
              --new-bundle-format \
              --predicate ${sbom} \
              --bundle ${sbom_without_ext}.sbom.bundle \
              ${sbom_without_ext}.tar.gz

            rm ${sbom}
          done

      - name: Upload artifact to release
        working-directory: ${{ runner.temp }}/artifacts
        run: gh release upload v${VERSION} * -R ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.build-artifact.outputs.version }}

      - name: Trigger Go Proxy Indexing
        run: |
          MAJOR_VERSION=$(echo "${GITHUB_REF_NAME}" | cut -d '.' -f 1 | sed 's/v//')

          if [[ $MAJOR_VERSION -ge 2 ]]; then
            curl https://sum.golang.org/lookup/github.com/${REPOSITORY}/v${MAJOR_VERSION}@${GITHUB_REF_NAME}
            curl https://proxy.golang.org/github.com/${REPOSITORY@L}/v${MAJOR_VERSION}/@v/${GITHUB_REF_NAME}.info
          else
            curl https://sum.golang.org/lookup/github.com/${REPOSITORY}@${GITHUB_REF_NAME}
            curl https://proxy.golang.org/github.com/${REPOSITORY@L}/@v/${GITHUB_REF_NAME}.info
          fi
        env:
          REPOSITORY: ${{ github.repository }}

  verify-artifact:
    name: Verify artifact
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    needs: [publish-release]
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@e6c2c5e321ed9123bda567646e2f96565e34abe1 # v0.2.4

      - name: Download assets from release
        run: gh release download ${GITHUB_REF_NAME} -R ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify checksum
        run: sha256sum -c checksums.txt

      - name: Verify signature
        run: |
          shopt -s nullglob
          for binary in *.tar.gz; do
            binary_basename="${binary%.tar.gz}"

            echo "Verify binary for ${binary}"
            cosign verify-blob \
              --certificate-identity "https://github.com/${{ github.repository }}/.github/workflows/release.yml@refs/tags/${GITHUB_REF_NAME}" \
              --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
              --bundle "https://github.com/${{ github.repository }}/releases/download/${GITHUB_REF_NAME}/${binary_basename}.sigstore.json" \
              ./${binary}
          done

      - name: Verify sbom attestation
        run: |
          for binary in *.tar.gz; do
            binary_basename="${binary%.tar.gz}"

            echo "Verify sbom for ${sbom}"
            cosign verify-blob-attestation \
              --type=cyclonedx \
              --new-bundle-format \
              --certificate-identity "https://github.com/${{ github.repository }}/.github/workflows/release.yml@refs/tags/${GITHUB_REF_NAME}" \
              --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
              --bundle ./${binary_basename}.sbom.bundle \
              ./${binary}
          done

  build-docker:
    name: Build docker
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write # needed for pushing docker image
    outputs:
      tags: ${{ steps.build.outputs.tags }}
      repository_lc: ${{ steps.repository_lc.outputs.REPOSITORY_LC }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-24.04
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Login to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get repository in lower case
        id: repository_lc
        run: |
          echo "REPOSITORY_LC=${REPOSITORY@L}" >> $GITHUB_OUTPUT
        env:
          REPOSITORY: ${{ github.repository }}

      - name: Get Git commit timestamps
        run: echo "TIMESTAMP=$(git log -1 --pretty=%ct)" >> $GITHUB_ENV

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ghcr.io/${{ github.repository }}

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          platforms: ${{ matrix.os }}/${{ matrix.arch }}
          tags: ghcr.io/${{ steps.repository_lc.outputs.REPOSITORY_LC }}
          labels: ${{ steps.meta.outputs.labels }}
          outputs: type=image,push-by-digest=true,name-canonical=true,push=true,oci-mediatypes=true,rewrite-timestamp=true
          build-args: |
            SOURCE_DATE_EPOCH=${{ env.TIMESTAMP }}
            VERSION=${GITHUB_REF_NAME}

      - name: Export digest
        run: |
          mkdir -p ${{ runner.temp }}/digests
          touch "${{ runner.temp }}/digests/${DIGEST#sha256:}"
        env:
          DIGEST: ${{ steps.build.outputs.digest }}

      - name: Upload digest
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: digests-${{ matrix.os }}-${{ matrix.arch }}
          path: ${{ runner.temp }}/digests/*
          if-no-files-found: error
          retention-days: 1

  merge-docker:
    name: Merge docker
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write # needed for pushing docker image
    outputs:
      tags: ${{ steps.meta.outputs.tags }}
      digest: ${{ steps.manifest.outputs.DIGEST }}
    needs: [build-docker]
    steps:
      - name: Downloads digests
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: digests-*
          merge-multiple: true
          path: ${{ runner.temp }}/digests

      - name: Login to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ghcr.io/${{ github.repository }}

      - name: Create manifest list and push
        id: manifest
        working-directory: ${{ runner.temp }}/digests
        run: |
          # Generate the list of tags
          TAGS=$(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON")

          # Generate the list of valid digests
          DIGESTS=""
          for file in *; do
            DIGESTS+="ghcr.io/${REPOSITORY_LC}@sha256:${file} "
          done

          docker buildx imagetools create $TAGS $DIGESTS

          MANIFEST_DIGEST=$(docker buildx imagetools inspect "ghcr.io/${REPOSITORY_LC}:${GITHUB_REF_NAME}" --format "{{json .Manifest.Digest}}" | tr -d '"')
          echo "DIGEST=${MANIFEST_DIGEST}" >> $GITHUB_OUTPUT
        env:
          REPOSITORY_LC: ${{ needs.build-docker.outputs.repository_lc }}

  sign-docker:
    name: Sign Docker
    runs-on: ubuntu-24.04
    permissions:
      packages: write # needed for pushing docker signature
      id-token: write # needed for signing the images with GitHub OIDC Token
    env:
      TAGS: ${{ needs.merge-docker.outputs.tags }}
      DIGEST: ${{ needs.merge-docker.outputs.digest }}
    needs: [merge-docker]
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@e6c2c5e321ed9123bda567646e2f96565e34abe1 # v0.2.4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Sign the images with GitHub OIDC Token
        run: |
          images=""
          for tag in ${TAGS}; do
            images+="${tag}@${DIGEST} "
          done
          echo "Sign image for ${images}"
          cosign sign -y --recursive ${images}

      - name: Generate SBOM
        run: |
          for tag in ${TAGS}; do
            sbom_filename=$(echo "$tag" | cut -d'/' -f3-)
            echo "Generate sbom for ${tag}@${DIGEST}"
            trivy image --format cyclonedx --output ${sbom_filename}.sbom ${tag}@${DIGEST}
          done

      - name: Attest images with SBOM
        run: |
          for tag in ${TAGS}; do
            sbom_filename=$(echo "$tag" | cut -d'/' -f3-)
            echo "Attest image for ${tag}@${DIGEST}"
            cosign attest -y \
              --type cyclonedx \
              --predicate ${sbom_filename}.sbom \
              ${tag}@${DIGEST}
          done

  verify-docker:
    name: Verify docker
    runs-on: ubuntu-24.04
    permissions:
      packages: read
    env:
      TAGS: ${{ needs.merge-docker.outputs.tags }}
      DIGEST: ${{ needs.merge-docker.outputs.digest }}
    needs: [merge-docker, sign-docker]
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Verify docker signature
        run: |
          for tag in ${TAGS}; do
            echo "Verify image for ${tag}@${DIGEST}"
            cosign verify ${tag}@${DIGEST} \
              --certificate-identity "https://github.com/${{ github.repository }}/.github/workflows/release.yml@refs/tags/${GITHUB_REF_NAME}" \
              --certificate-oidc-issuer "https://token.actions.githubusercontent.com"
          done

      - name: Verify docker attestation
        run: |
          for tag in ${TAGS}; do
            echo "Verify image for ${tag}@${DIGEST}"
            cosign verify-attestation ${tag}@${DIGEST} \
              --type=cyclonedx \
              --certificate-identity "https://github.com/${{ github.repository }}/.github/workflows/release.yml@refs/tags/${GITHUB_REF_NAME}" \
              --certificate-oidc-issuer "https://token.actions.githubusercontent.com"
          done

  publish-release:
    name: Publish release
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    needs: [create-draft-release, verify-artifact, verify-docker]
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Create release
        run: gh release edit ${GITHUB_REF_NAME} --draft=false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
